/ =================é‡‘å±±é€‚é…å¼€å§‹===================
// airscriptæ£€æµ‹ç‰ˆæœ¬
function checkVesion(){
  try{
    let temp = Application.Range("A1").Text;
    Application.Range("A1").Value  = temp
    console.log("ğŸ˜¶â€ğŸŒ«ï¸ æ£€æµ‹åˆ°å½“å‰airscriptç‰ˆæœ¬ä¸º1.0ï¼Œè¿›è¡Œ1.0é€‚é…")
  }catch{
    console.log("ğŸ˜¶â€ğŸŒ«ï¸ æ£€æµ‹åˆ°å½“å‰airscriptç‰ˆæœ¬ä¸º2.0ï¼Œè¿›è¡Œ2.0é€‚é…")
    version = 2
  }
}

// æ¨é€ç›¸å…³
// è·å–æ—¶é—´
function getDate(){
  let currentDate = new Date();
  currentDate = currentDate.getFullYear() + '/' + (currentDate.getMonth() + 1).toString() + '/' + currentDate.getDate().toString();
  return currentDate
}

// å°†æ¶ˆæ¯å†™å…¥CONFIGè¡¨ä¸­ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹‹åç»Ÿä¸€å‘é€
function writeMessageQueue(message){
  // å½“å¤©æ—¶é—´
  let todayDate = getDate()
  flagConfig = ActivateSheet(sheetNameConfig); // æ¿€æ´»ä¸»é…ç½®è¡¨
  // ä¸»é…ç½®å·¥ä½œè¡¨å­˜åœ¨
  if (flagConfig == 1) {
    console.log("âœ¨ å¼€å§‹å°†ç»“æœå†™å…¥ä¸»é…ç½®è¡¨");
    for (let i = 2; i <= 100; i++) {
      if(version == 1){
        // æ‰¾åˆ°æŒ‡å®šçš„è¡¨è¡Œ
        if(Application.Range("A" + (i + 2)).Value == sheetNameSubConfig){
          // å†™å…¥æ›´æ–°çš„æ—¶é—´
          Application.Range("F" + (i + 2)).Value = todayDate
          // å†™å…¥æ¶ˆæ¯
          Application.Range("G" + (i + 2)).Value = message
          console.log("âœ¨ å†™å…¥ç»“æœå®Œæˆ");
          break;
        }
      }else{
        // æ‰¾åˆ°æŒ‡å®šçš„è¡¨è¡Œ
        if(Application.Range("A" + (i + 2)).Value2 == sheetNameSubConfig){
          // å†™å…¥æ›´æ–°çš„æ—¶é—´
          Application.Range("F" + (i + 2)).Value2 = todayDate
          // å†™å…¥æ¶ˆæ¯
          Application.Range("G" + (i + 2)).Value2 = message
          console.log("âœ¨ å†™å…¥ç»“æœå®Œæˆ");
          break;
        }
      }
      
    }
  }
}

// æ€»æ¨é€
function push(message) {
  writeMessageQueue(message)  // å°†æ¶ˆæ¯å†™å…¥CONFIGè¡¨ä¸­
  // if (message != "") {
  //   // message = messagePushHeader + message // æ¶ˆæ¯å¤´æœ€å‰æ–¹é»˜è®¤å­˜æ”¾ï¼šã€xxxxã€‘
  //   let length = jsonPush.length;
  //   let name;
  //   let key;
  //   for (let i = 0; i < length; i++) {
  //     if (jsonPush[i].flag == 1) {
  //       name = jsonPush[i].name;
  //       key = jsonPush[i].key;
  //       if (name == "bark") {
  //         bark(message, key);
  //       } else if (name == "pushplus") {
  //         pushplus(message, key);
  //       } else if (name == "ServerChan") {
  //         serverchan(message, key);
  //       } else if (name == "email") {
  //         email(message);
  //       } else if (name == "dingtalk") {
  //         dingtalk(message, key);
  //       } else if (name == "discord") {
  //         discord(message, key);
  //       }
  //     }
  //   }
  // } else {
  //   console.log("ğŸ³ æ¶ˆæ¯ä¸ºç©ºä¸æ¨é€");
  // }
}


// æ¨é€barkæ¶ˆæ¯
function bark(message, key) {
    if (key != "") {
      message = messagePushHeader + message // æ¶ˆæ¯å¤´æœ€å‰æ–¹é»˜è®¤å­˜æ”¾ï¼šã€xxxxã€‘
      message = encodeURIComponent(message)
      BARK_ICON = "https://s21.ax1x.com/2024/06/23/pkrUkfe.png"
    let url = "https://api.day.app/" + key + "/" + message + "/" + "?icon=" + BARK_ICON;
    // è‹¥éœ€è¦ä¿®æ”¹æ¨é€çš„åˆ†ç»„ï¼Œåˆ™å°†ä¸Šé¢ä¸€è¡Œæ”¹ä¸ºå¦‚ä¸‹çš„å½¢å¼
    // let url = 'https://api.day.app/' + bark_id + "/" + message + "?group=åˆ†ç»„å";
    let resp = HTTP.get(url, {
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
    });
    sleep(5000);
    }
}

// æ¨é€pushplusæ¶ˆæ¯
function pushplus(message, key) {
  if (key != "") {
      message = encodeURIComponent(message)
    // url = "http://www.pushplus.plus/send?token=" + key + "&content=" + message;
    url = "http://www.pushplus.plus/send?token=" + key + "&content=" + message + "&title=" + pushHeader;  // å¢åŠ æ ‡é¢˜
    let resp = HTTP.fetch(url, {
      method: "get",
    });
    sleep(5000);
  }
}

// æ¨é€serverchanæ¶ˆæ¯
function serverchan(message, key) {
  if (key != "") {
    url =
      "https://sctapi.ftqq.com/" +
      key +
      ".send" +
      "?title=" + messagePushHeader +
      "&desp=" +
      message;
    let resp = HTTP.fetch(url, {
      method: "get",
    });
    sleep(5000);
  }
}

// emailé‚®ç®±æ¨é€
function email(message) {
  var myDate = new Date(); // åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºå½“å‰æ—¶é—´çš„ Date å¯¹è±¡
  var data_time = myDate.toLocaleDateString(); // è·å–å½“å‰æ—¥æœŸçš„å­—ç¬¦ä¸²è¡¨ç¤º
  let server = jsonEmail.server;
  let port = parseInt(jsonEmail.port); // è½¬æˆæ•´å½¢
  let sender = jsonEmail.sender;
  let authorizationCode = jsonEmail.authorizationCode;

  let mailer;
  mailer = SMTP.login({
    host: server,
    port: port,
    username: sender,
    password: authorizationCode,
    secure: true,
  });
  mailer.send({
    from: pushHeader + "<" + sender + ">",
    to: sender,
    subject: pushHeader + " - " + data_time,
    text: message,
  });
  // console.log("ğŸ³ å·²å‘é€é‚®ä»¶è‡³ï¼š" + sender);
  console.log("ğŸ³ å·²å‘é€é‚®ä»¶");
  sleep(5000);
}

// é‚®ç®±é…ç½®
function emailConfig() {
  console.log("ğŸ³ å¼€å§‹è¯»å–é‚®ç®±é…ç½®");
  let length = jsonPush.length; // å› ä¸ºæ­¤jsonæ•°æ®å¯æ— åºï¼Œå› æ­¤éœ€è¦éå†
  let name;
  for (let i = 0; i < length; i++) {
    name = jsonPush[i].name;
    if (name == "email") {
      if (jsonPush[i].flag == 1) {
        let flag = ActivateSheet(sheetNameEmail); // æ¿€æ´»é‚®ç®±è¡¨
        // é‚®ç®±è¡¨å­˜åœ¨
        // var email = {
        //   'email':'', 'port':'', 'sender':'', 'authorizationCode':''
        // } // æœ‰æ•ˆé…ç½®
        if (flag == 1) {
          console.log("ğŸ³ å¼€å§‹è¯»å–é‚®ç®±è¡¨");
          for (let i = 2; i <= 2; i++) {
            // ä»å·¥ä½œè¡¨ä¸­è¯»å–æ¨é€æ•°æ®
            jsonEmail.server = Application.Range("A" + i).Text;
            jsonEmail.port = Application.Range("B" + i).Text;
            jsonEmail.sender = Application.Range("C" + i).Text;
            jsonEmail.authorizationCode = Application.Range("D" + i).Text;
            if (Application.Range("A" + i).Text == "") {
              // å¦‚æœä¸ºç©ºè¡Œï¼Œåˆ™æå‰ç»“æŸè¯»å–
              break;
            }
          }
          // console.log(jsonEmail)
        }
        break;
      }
    }
  }
}

// æ¨é€é’‰é’‰æœºå™¨äºº
function dingtalk(message, key) {
  message = messagePushHeader + message // æ¶ˆæ¯å¤´æœ€å‰æ–¹é»˜è®¤å­˜æ”¾ï¼šã€xxxxã€‘
  let url = "https://oapi.dingtalk.com/robot/send?access_token=" + key;
  let resp = HTTP.post(url, { msgtype: "text", text: { content: message } });
  // console.log(resp.text())
  sleep(5000);
}

// æ¨é€Discordæœºå™¨äºº
function discord(message, key) {
  message = messagePushHeader + message // æ¶ˆæ¯å¤´æœ€å‰æ–¹é»˜è®¤å­˜æ”¾ï¼šã€xxxxã€‘
  let url = key;
  let resp = HTTP.post(url, { content: message });
  //console.log(resp.text())
  sleep(5000);
}

// =================é‡‘å±±é€‚é…ç»“æŸ===================

